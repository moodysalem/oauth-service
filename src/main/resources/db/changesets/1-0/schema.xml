<databaseChangeLog
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

  <changeSet id="Change default collation for mysql database to utf8mb4" author="moody.salem" dbms="mysql">
    <sql>ALTER DATABASE DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;</sql>
  </changeSet>

  <changeSet id="create rev_info table" author="moody.salem">
    <createTable tableName="rev_info">
      <column name="REV" type="INT">
        <constraints nullable="false"/>
      </column>
      <column name="REVTSTMP" type="BIGINT">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="applications table" author="moody.salem">
    <createTable tableName="applications">
      <column name="id" type="${UUID_TYPE}">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="created" type="LONG">
        <constraints nullable="false"/>
      </column>
      <column name="updated" type="LONG">
        <constraints nullable="false"/>
      </column>
      <column name="version" type="BIGINT" defaultValue="0">
        <constraints nullable="false"/>
      </column>
      <column name="name" type="VARCHAR(191)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="description" type="${TEXT}">
        <constraints nullable="true"/>
      </column>
      <column name="support_email" type="VARCHAR(191)">
        <constraints nullable="false"/>
      </column>
      <column name="owner_id" type="${UUID_TYPE}"/>
      <column name="google_client_id" type="VARCHAR(191)">
        <constraints nullable="true"/>
      </column>
      <column name="google_client_secret" type="VARCHAR(191)">
        <constraints nullable="true"/>
      </column>
      <column name="stylesheet_url" type="${TEXT}"/>
      <column name="favicon_url" type="${TEXT}"/>
      <column name="logo_url" type="${TEXT}"/>
    </createTable>
    <addUniqueConstraint tableName="applications" columnNames="google_client_id,google_client_secret"
                         constraintName="uk_app_google_cred"/>
  </changeSet>

  <changeSet id="scopes table" author="moody.salem">
    <createTable tableName="scopes">
      <column name="id" type="${UUID_TYPE}">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="created" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="updated" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="version" type="BIGINT" defaultValue="0">
        <constraints nullable="false"/>
      </column>
      <column name="application_id" type="${UUID_TYPE}">
        <constraints nullable="false"/>
      </column>
      <column name="name" type="VARCHAR(191)">
        <constraints nullable="false"/>
      </column>
      <column name="display_name" type="VARCHAR(191)">
        <constraints nullable="false"/>
      </column>
      <column name="thumbnail" type="${TEXT}">
        <constraints nullable="true"/>
      </column>
      <column name="description" type="${TEXT}">
        <constraints nullable="true"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="scopes" baseColumnNames="application_id"
                             constraintName="fk_scopes_applications"
                             referencedTableName="applications"
                             referencedColumnNames="id"/>
    <addUniqueConstraint tableName="scopes" columnNames="application_id,name" constraintName="uk_scopes_names"/>
  </changeSet>

  <changeSet id="users table" author="moody.salem">
    <createTable tableName="users">
      <column name="id" type="${UUID_TYPE}">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="created" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="updated" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="version" type="BIGINT" defaultValue="0">
        <constraints nullable="false"/>
      </column>
      <column name="application_id" type="${UUID_TYPE}">
        <constraints nullable="false"/>
      </column>
      <column name="email" type="VARCHAR(191)">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="users" baseColumnNames="application_id"
                             constraintName="fk_users_applications"
                             referencedTableName="applications"
                             referencedColumnNames="id"/>
    <addForeignKeyConstraint baseTableName="applications" baseColumnNames="owner_id"
                             constraintName="fk_applications_owner"
                             referencedTableName="users"
                             referencedColumnNames="id"/>
    <addUniqueConstraint tableName="users" columnNames="application_id,email" constraintName="uk_users_email"/>
  </changeSet>

  <changeSet id="clients table" author="moody.salem">
    <createTable tableName="clients">
      <column name="id" type="${UUID_TYPE}">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="created" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="updated" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="version" type="BIGINT" defaultValue="0">
        <constraints nullable="false"/>
      </column>
      <column name="application_id" type="${UUID_TYPE}">
        <constraints nullable="false"/>
      </column>
      <column name="name" type="VARCHAR(191)">
        <constraints nullable="false"/>
      </column>
      <column name="confidential" type="BOOLEAN">
        <constraints nullable="false"/>
      </column>
      <column name="token_ttl" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="refresh_token_ttl" type="BIGINT">
        <constraints nullable="true"/>
      </column>
      <column name="identifier" type="VARCHAR(191)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="secret" type="VARCHAR(191)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="creator_id" type="${UUID_TYPE}">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="clients" baseColumnNames="application_id"
                             constraintName="fk_clients_applications"
                             referencedTableName="applications"
                             referencedColumnNames="id"/>
    <addForeignKeyConstraint baseTableName="clients" baseColumnNames="creator_id"
                             constraintName="fk_clients_users"
                             referencedTableName="users"
                             referencedColumnNames="id"/>
  </changeSet>

  <changeSet id="client redirect uris table" author="moody.salem">
    <!-- the list of URIs that a client can redirect to -->
    <createTable tableName="client_uris">
      <column name="client_id" type="${UUID_TYPE}">
        <constraints nullable="false"/>
      </column>
      <column name="uri" type="VARCHAR(191)">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="client_uris" baseColumnNames="client_id"
                             constraintName="fk_client_uris_client"
                             referencedTableName="clients"
                             referencedColumnNames="id"/>
    <addUniqueConstraint tableName="client_uris" columnNames="client_id,uri"/>
  </changeSet>

  <changeSet id="client Permitted Flows" author="moody.salem">
    <!-- the list of flows a client is allowed to use -->
    <createTable tableName="client_flows">
      <column name="client_id" type="${UUID_TYPE}">
        <constraints nullable="false"/>
      </column>
      <column name="flow" type="VARCHAR(50)">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="client_flows" baseColumnNames="client_id"
                             constraintName="fk_client_flows_client"
                             referencedTableName="clients"
                             referencedColumnNames="id"/>
    <addUniqueConstraint tableName="client_flows" columnNames="client_id,flow"/>
  </changeSet>

  <changeSet id="token table" author="moody.salem">
    <createTable tableName="tokens">
      <column name="id" type="${UUID_TYPE}">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="created" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="updated" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="version" type="BIGINT" defaultValue="0">
        <constraints nullable="false"/>
      </column>
      <column name="user_id" type="${UUID_TYPE}">
        <constraints nullable="true"/>
      </column>
      <column name="client_id" type="${UUID_TYPE}">
        <constraints nullable="false"/>
      </column>
      <column name="token" type="VARCHAR(191)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="refresh_token_id" type="${UUID_TYPE}">
        <constraints nullable="true"/>
      </column>
      <column name="redirect_uri" type="${TEXT}">
        <constraints nullable="true"/>
      </column>
      <column name="expires" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="type" type="VARCHAR(191)">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="tokens" baseColumnNames="user_id" constraintName="fk_tokens_users"
                             referencedTableName="users"
                             referencedColumnNames="id"/>
    <addForeignKeyConstraint baseTableName="tokens" baseColumnNames="client_id" constraintName="fk_tokens_clients"
                             referencedTableName="clients"
                             referencedColumnNames="id"/>
    <addForeignKeyConstraint baseTableName="tokens" baseColumnNames="refresh_token_id"
                             constraintName="fk_token_refresh_token"
                             referencedTableName="tokens"
                             referencedColumnNames="id"/>
  </changeSet>

  <changeSet author="moody.salem" id="client_scopes Table">
    <createTable tableName="client_scopes">
      <column name="id" type="${UUID_TYPE}">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="created" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="updated" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="version" type="BIGINT" defaultValue="0">
        <constraints nullable="false"/>
      </column>
      <column name="client_id" type="${UUID_TYPE}">
        <constraints nullable="false"/>
      </column>
      <column name="scope_id" type="${UUID_TYPE}">
        <constraints nullable="false"/>
      </column>
      <column name="priority" type="VARCHAR(50)">
        <constraints nullable="false"/>
      </column>
      <column name="reason" type="${TEXT}"/>
    </createTable>
    <addForeignKeyConstraint baseTableName="client_scopes" baseColumnNames="client_id"
                             constraintName="fk_client_scopes_clients"
                             referencedTableName="clients"
                             referencedColumnNames="id"/>
    <addForeignKeyConstraint baseTableName="client_scopes" baseColumnNames="scope_id"
                             constraintName="fk_client_scopes_scopes"
                             referencedTableName="scopes"
                             referencedColumnNames="id"/>
    <addUniqueConstraint tableName="client_scopes" columnNames="client_id,scope_id"/>
  </changeSet>

  <changeSet id="accepted scopes table" author="moody.salem">
    <createTable tableName="accepted_scopes">
      <column name="id" type="${UUID_TYPE}">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="created" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="updated" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="version" type="BIGINT" defaultValue="0">
        <constraints nullable="false"/>
      </column>
      <column name="user_id" type="${UUID_TYPE}">
        <constraints nullable="false"/>
      </column>
      <column name="client_scope_id" type="${UUID_TYPE}">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="accepted_scopes" baseColumnNames="user_id"
                             constraintName="fk_accepted_scopes_users"
                             referencedTableName="users"
                             referencedColumnNames="id"/>
    <!-- if you delete the client scope, it is unaccepted for all users -->
    <addForeignKeyConstraint baseTableName="accepted_scopes" baseColumnNames="client_scope_id"
                             constraintName="fk_accepted_scopes_client_scopes"
                             referencedTableName="client_scopes"
                             referencedColumnNames="id"/>
    <addUniqueConstraint tableName="accepted_scopes" columnNames="user_id,client_scope_id"/>
  </changeSet>

  <!-- this table lists all the users scopes that are granted with a token -->
  <changeSet id="token accepted scopes join table" author="moody.salem">
    <createTable tableName="token_accepted_scopes">
      <column name="token_id" type="${UUID_TYPE}">
        <constraints nullable="false"/>
      </column>
      <column name="accepted_scope_id" type="${UUID_TYPE}">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="token_accepted_scopes" baseColumnNames="token_id"
                             constraintName="fk_token_accepted_scopes_token"
                             referencedTableName="tokens"
                             referencedColumnNames="id"/>
    <!-- if you delete the accepted scope, all the tokens drop the scope -->
    <addForeignKeyConstraint baseTableName="token_accepted_scopes" baseColumnNames="accepted_scope_id"
                             constraintName="fk_token_accepted_scopes_scope"
                             referencedTableName="accepted_scopes"
                             referencedColumnNames="id"/>
  </changeSet>

  <!-- this table lists all the client scopes that are granted with a token -->
  <changeSet id="token client scopes join table" author="moody.salem">
    <createTable tableName="token_client_scopes">
      <column name="token_id" type="${UUID_TYPE}">
        <constraints nullable="false"/>
      </column>
      <column name="client_scope_id" type="${UUID_TYPE}">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="token_client_scopes" baseColumnNames="token_id"
                             constraintName="fk_token_client_scopes_tokens"
                             referencedTableName="tokens"
                             referencedColumnNames="id"/>
    <addForeignKeyConstraint baseTableName="token_client_scopes" baseColumnNames="client_scope_id"
                             constraintName="fk_token_client_scopes_client_scopes"
                             referencedTableName="client_scopes"
                             referencedColumnNames="id"/>
  </changeSet>

  <changeSet id="login_cookies table" author="moody.salem">
    <createTable tableName="login_cookies">
      <column name="id" type="${UUID_TYPE}">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="created" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="updated" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="version" type="BIGINT" defaultValue="0">
        <constraints nullable="false"/>
      </column>
      <column name="secret" type="VARCHAR(191)">
        <constraints nullable="false"/>
      </column>
      <column name="remember_me" type="BOOLEAN">
        <constraints nullable="false"/>
      </column>
      <column name="user_id" type="${UUID_TYPE}">
        <constraints nullable="false"/>
      </column>
      <column name="expires" type="BIGINT">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="login_cookies" baseColumnNames="user_id"
                             constraintName="fk_login_cookies_users"
                             referencedTableName="users"
                             referencedColumnNames="id"/>
  </changeSet>

  <changeSet id="Call Log" author="moody.salem">
    <createTable tableName="call_log">
      <column name="id" type="${UUID_TYPE}">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="created" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="updated" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="version" type="BIGINT" defaultValue="0">
        <constraints nullable="false"/>
      </column>
      <column name="ip" type="VARCHAR(50)">
        <constraints nullable="false"/>
      </column>
      <column name="path" type="${TEXT}">
        <constraints nullable="false"/>
      </column>
      <column name="method" type="VARCHAR(10)">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="Client Call Log" author="moody.slaem">
    <createTable tableName="client_call_log">
      <column name="id" type="${UUID_TYPE}">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="client_id" type="${UUID_TYPE}">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addForeignKeyConstraint baseTableName="client_call_log" baseColumnNames="id"
                             constraintName="fk_client_call_log_cl"
                             referencedTableName="call_log"
                             referencedColumnNames="id"
                             onDelete="CASCADE"/>
    <addForeignKeyConstraint baseTableName="client_call_log" baseColumnNames="client_id"
                             constraintName="fk_client_call_log_client"
                             referencedTableName="clients"
                             referencedColumnNames="id"/>
  </changeSet>

  <changeSet id="Application Call Log" author="moody.salem">
    <createTable tableName="application_call_log">
      <column name="id" type="${UUID_TYPE}">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="application_id" type="${UUID_TYPE}">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addForeignKeyConstraint baseTableName="application_call_log" baseColumnNames="id"
                             constraintName="fk_application_call_log_cl"
                             referencedTableName="call_log"
                             referencedColumnNames="id"
                             onDelete="CASCADE"/>
    <addForeignKeyConstraint baseTableName="application_call_log" baseColumnNames="application_id"
                             constraintName="fk_application_call_log_applications"
                             referencedTableName="applications"
                             referencedColumnNames="id"/>
  </changeSet>

  <changeSet id="login_code table" author="moody.salem">
    <createTable tableName="login_codes">
      <column name="id" type="${UUID_TYPE}">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="created" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="updated" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="version" type="BIGINT" defaultValue="0">
        <constraints nullable="false"/>
      </column>
      <column name="client_id" type="${UUID_TYPE}">
        <constraints nullable="false"/>
      </column>
      <column name="user_id" type="${UUID_TYPE}">
        <constraints nullable="false"/>
      </column>
      <column name="expires" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="code" type="VARCHAR(191)">
        <constraints nullable="false"/>
      </column>
      <column name="remember_me" type="BOOLEAN">
        <constraints nullable="false"/>
      </column>
      <column name="response_type" type="VARCHAR(20)">
        <constraints nullable="false"/>
      </column>
      <column name="host" type="VARCHAR(2048)">
        <constraints nullable="false"/>
      </column>
      <column name="redirect_uri" type="VARCHAR(2048)">
        <constraints nullable="false"/>
      </column>
      <column name="scope" type="VARCHAR(2048)"/>
      <column name="state" type="VARCHAR(2048)"/>
      <column name="used" type="BOOLEAN">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addForeignKeyConstraint baseTableName="login_codes" baseColumnNames="client_id"
                             constraintName="fk_login_codes_clients"
                             referencedTableName="clients"
                             referencedColumnNames="id"/>
    <addForeignKeyConstraint baseTableName="login_codes" baseColumnNames="user_id" constraintName="fk_login_codes_users"
                             referencedTableName="users"
                             referencedColumnNames="id"/>
    <addUniqueConstraint tableName="login_codes" columnNames="code" constraintName="uk_login_codes_code"/>
  </changeSet>


</databaseChangeLog>