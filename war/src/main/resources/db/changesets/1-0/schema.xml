<databaseChangeLog
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd">

  <changeSet id="Application Table" author="moody.salem">
    <createTable tableName="Application">
      <column name="id" autoIncrement="true" type="BIGINT">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="created" type="TIMESTAMP" defaultValue="${now}">
        <constraints nullable="false"/>
      </column>
      <column name="updated" type="TIMESTAMP" defaultValue="${now}">
        <constraints nullable="false"/>
      </column>
      <column name="version" type="BIGINT" defaultValue="0">
        <constraints nullable="false"/>
      </column>
      <column name="name" type="VARCHAR(191)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>
    <sql dbms="mysql">ALTER TABLE Application CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;</sql>
  </changeSet>

  <changeSet id="Scopes Table" author="moody.salem">
    <createTable tableName="Scope">
      <column name="id" autoIncrement="true" type="BIGINT">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="created" type="TIMESTAMP" defaultValue="${now}">
        <constraints nullable="false"/>
      </column>
      <column name="updated" type="TIMESTAMP" defaultValue="${now}">
        <constraints nullable="false"/>
      </column>
      <column name="version" type="BIGINT" defaultValue="0">
        <constraints nullable="false"/>
      </column>
      <column name="applicationId" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="name" type="VARCHAR(191)">
        <constraints nullable="false"/>
      </column>
      <column name="displayName" type="VARCHAR(191)">
        <constraints nullable="false"/>
      </column>
      <column name="thumbnail" type="VARCHAR(191)">
        <constraints nullable="true"/>
      </column>
      <column name="description" type="VARCHAR(191)">
        <constraints nullable="true"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="Scope" baseColumnNames="applicationId"
                             constraintName="FK_Scope_Application"
                             referencedTableName="Application"
                             referencedColumnNames="id"/>
    <addUniqueConstraint tableName="Scope" columnNames="applicationId,name"/>
    <sql dbms="mysql">ALTER TABLE Scope CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;</sql>
  </changeSet>

  <changeSet id="Users Table" author="moody.salem">
    <createTable tableName="User">
      <column name="id" autoIncrement="true" type="BIGINT">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="created" type="TIMESTAMP" defaultValue="${now}">
        <constraints nullable="false"/>
      </column>
      <column name="updated" type="TIMESTAMP" defaultValue="${now}">
        <constraints nullable="false"/>
      </column>
      <column name="version" type="BIGINT" defaultValue="0">
        <constraints nullable="false"/>
      </column>
      <column name="applicationId" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="email" type="VARCHAR(191)">
        <constraints nullable="false"/>
      </column>
      <column name="password" type="VARCHAR(191)">
        <constraints nullable="true"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="User" baseColumnNames="applicationId" constraintName="FK_User_Application"
                             referencedTableName="Application"
                             referencedColumnNames="id"/>
    <addUniqueConstraint tableName="User" columnNames="applicationId,email"/>
    <sql dbms="mysql">ALTER TABLE User CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;</sql>
  </changeSet>

  <changeSet id="Client Table" author="moody.salem">
    <createTable tableName="Client">
      <column name="id" autoIncrement="true" type="BIGINT">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="created" type="TIMESTAMP" defaultValue="${now}">
        <constraints nullable="false"/>
      </column>
      <column name="updated" type="TIMESTAMP" defaultValue="${now}">
        <constraints nullable="false"/>
      </column>
      <column name="version" type="BIGINT" defaultValue="0">
        <constraints nullable="false"/>
      </column>
      <column name="applicationId" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="name" type="VARCHAR(191)">
        <constraints nullable="false"/>
      </column>
      <column name="tokenTtl" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="identifier" type="VARCHAR(191)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="secret" type="VARCHAR(191)">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="Client" baseColumnNames="applicationId"
                             constraintName="FK_CLIENT_APPLICATION"
                             referencedTableName="Application"
                             referencedColumnNames="id"/>
    <sql dbms="mysql">ALTER TABLE Client CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;</sql>
  </changeSet>

  <changeSet id="Client Redirect URI table" author="moody.salem">
    <!-- the list of URIs that a client can redirect to -->
    <createTable tableName="Client_URI">
      <column name="clientId" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="uri" type="VARCHAR(191)">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addUniqueConstraint tableName="Client_URI" columnNames="clientId,uri"/>
    <addForeignKeyConstraint baseTableName="Client_URI" baseColumnNames="clientId"
                             constraintName="FK_Client_URI_Client"
                             referencedTableName="Client"
                             referencedColumnNames="id"/>
    <sql dbms="mysql">ALTER TABLE Client_URI CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;</sql>
  </changeSet>

  <changeSet id="Client Permitted Flows" author="moody.salem">
    <!-- the list of flows a client is allowed to use -->
    <createTable tableName="Client_Flow">
      <column name="clientId" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="flow" type="VARCHAR(191)">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addUniqueConstraint tableName="Client_Flow" columnNames="clientId,flow"/>
    <addForeignKeyConstraint baseTableName="Client_Flow" baseColumnNames="clientId"
                             constraintName="FK_Client_Flow_Client"
                             referencedTableName="Client"
                             referencedColumnNames="id"/>
    <sql dbms="mysql">ALTER TABLE Client_Flow CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;</sql>
  </changeSet>


  <changeSet id="Token Table" author="moody.salem">
    <createTable tableName="Token">
      <column name="id" autoIncrement="true" type="BIGINT">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="created" type="TIMESTAMP" defaultValue="${now}">
        <constraints nullable="false"/>
      </column>
      <column name="updated" type="TIMESTAMP" defaultValue="${now}">
        <constraints nullable="false"/>
      </column>
      <column name="version" type="BIGINT" defaultValue="0">
        <constraints nullable="false"/>
      </column>
      <column name="userId" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="clientId" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="token" type="VARCHAR(191)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="expires" type="TIMESTAMP">
        <constraints nullable="false"/>
      </column>
      <column name="type" type="VARCHAR(191)">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="Token" baseColumnNames="userId" constraintName="FK_Token_User"
                             referencedTableName="User"
                             referencedColumnNames="id"/>
    <sql dbms="mysql">ALTER TABLE Token CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;</sql>
  </changeSet>

  <changeSet author="moody.salem" id="ClientScope Table">
    <createTable tableName="ClientScope">
      <column name="id" autoIncrement="true" type="BIGINT">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="created" type="TIMESTAMP" defaultValue="${now}">
        <constraints nullable="false"/>
      </column>
      <column name="updated" type="TIMESTAMP" defaultValue="${now}">
        <constraints nullable="false"/>
      </column>
      <column name="version" type="BIGINT" defaultValue="0">
        <constraints nullable="false"/>
      </column>
      <column name="clientId" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="scopeId" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="priority" type="VARCHAR(191)">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="ClientScope" baseColumnNames="clientId"
                             constraintName="FK_ClientScope_Client"
                             referencedTableName="Client"
                             referencedColumnNames="id"/>
    <addForeignKeyConstraint baseTableName="ClientScope" baseColumnNames="scopeId"
                             constraintName="FK_ClientScope_Scope"
                             referencedTableName="Scope"
                             referencedColumnNames="id"/>
    <addUniqueConstraint tableName="ClientScope" columnNames="clientId,scopeId"/>
  </changeSet>

  <changeSet id="Accepted Scopes Table" author="moody.salem">
    <createTable tableName="AcceptedScope">
      <column name="id" autoIncrement="true" type="BIGINT">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="created" type="TIMESTAMP" defaultValue="${now}">
        <constraints nullable="false"/>
      </column>
      <column name="updated" type="TIMESTAMP" defaultValue="${now}">
        <constraints nullable="false"/>
      </column>
      <column name="version" type="BIGINT" defaultValue="0">
        <constraints nullable="false"/>
      </column>
      <column name="userId" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="clientScopeId" type="BIGINT">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="AcceptedScope" baseColumnNames="userId"
                             constraintName="FK_AcceptedScope_User"
                             referencedTableName="User"
                             referencedColumnNames="id"/>
    <addForeignKeyConstraint baseTableName="AcceptedScope" baseColumnNames="clientScopeId"
                             constraintName="FK_AcceptedScope_ClientScope"
                             referencedTableName="ClientScope"
                             referencedColumnNames="id"/>
    <addUniqueConstraint tableName="AcceptedScope" columnNames="userId,clientScopeId"/>
  </changeSet>

  <!-- this table lists all the scopes that are granted with a token -->
  <changeSet id="Token Accepted Scopes Join Table" author="moody.salem">
    <createTable tableName="Token_AcceptedScope">
      <column name="tokenId" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="acceptedScopeId" type="BIGINT">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseTableName="Token_AcceptedScope" baseColumnNames="tokenId"
                             constraintName="FK_Token_AcceptedScope_Token"
                             referencedTableName="Token"
                             referencedColumnNames="id"/>
    <addForeignKeyConstraint baseTableName="Token_AcceptedScope" baseColumnNames="acceptedScopeId"
                             constraintName="FK_Token_AcceptedScope_AcceptedScope"
                             referencedTableName="AcceptedScope"
                             referencedColumnNames="id"/>
  </changeSet>

</databaseChangeLog>